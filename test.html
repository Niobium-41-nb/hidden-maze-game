<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>隐藏迷宫 - 功能测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            line-height: 1.6;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 3px;
        }
        .pass {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .fail {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .running {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        button {
            padding: 8px 16px;
            margin: 5px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>隐藏迷宫游戏 - 功能测试</h1>
    
    <div class="test-section">
        <h2>1. 文件完整性测试</h2>
        <div id="file-test-result" class="test-result running">测试中...</div>
    </div>
    
    <div class="test-section">
        <h2>2. JavaScript语法测试</h2>
        <div id="syntax-test-result" class="test-result running">测试中...</div>
    </div>
    
    <div class="test-section">
        <h2>3. 迷宫生成测试</h2>
        <button onclick="testMazeGeneration()">运行迷宫生成测试</button>
        <div id="maze-test-result" class="test-result">点击按钮运行测试</div>
    </div>
    
    <div class="test-section">
        <h2>4. 游戏逻辑测试</h2>
        <button onclick="testGameLogic()">运行游戏逻辑测试</button>
        <div id="game-test-result" class="test-result">点击按钮运行测试</div>
    </div>
    
    <div class="test-section">
        <h2>5. 完整游戏测试</h2>
        <button onclick="window.open('index.html', '_blank')">打开完整游戏</button>
        <p>点击按钮在新标签页中打开完整游戏界面进行测试。</p>
    </div>
    
    <div class="test-section">
        <h2>测试结果汇总</h2>
        <div id="summary-result" class="test-result">等待测试完成...</div>
    </div>
    
    <script>
        // 测试结果跟踪
        const testResults = {
            files: false,
            syntax: false,
            maze: false,
            game: false
        };
        
        // 1. 文件完整性测试
        function testFileIntegrity() {
            const requiredFiles = [
                'index.html',
                'style.css',
                'maze.js',
                'game.js',
                'view.js',
                'ui.js',
                'main.js'
            ];
            
            const missingFiles = [];
            
            // 使用fetch检查文件是否存在
            const checks = requiredFiles.map(file => {
                return fetch(file)
                    .then(response => {
                        if (!response.ok) {
                            missingFiles.push(file);
                        }
                        return response.ok;
                    })
                    .catch(() => {
                        missingFiles.push(file);
                        return false;
                    });
            });
            
            Promise.all(checks).then(() => {
                const resultElement = document.getElementById('file-test-result');
                if (missingFiles.length === 0) {
                    resultElement.className = 'test-result pass';
                    resultElement.innerHTML = '✓ 所有必需文件都存在';
                    testResults.files = true;
                } else {
                    resultElement.className = 'test-result fail';
                    resultElement.innerHTML = `✗ 缺少文件: ${missingFiles.join(', ')}`;
                    testResults.files = false;
                }
                updateSummary();
            });
        }
        
        // 2. JavaScript语法测试
        function testJavaScriptSyntax() {
            const resultElement = document.getElementById('syntax-test-result');
            
            try {
                // 动态加载并检查JavaScript文件
                const scripts = ['maze.js', 'game.js', 'view.js', 'ui.js', 'main.js'];
                let allValid = true;
                let errorMessages = [];
                
                // 注意：由于同源策略限制，我们只能检查是否能够加载
                // 实际语法检查需要在服务器环境下进行
                const loadChecks = scripts.map(script => {
                    return fetch(script)
                        .then(response => response.text())
                        .then(code => {
                            try {
                                // 尝试解析JavaScript
                                new Function(code);
                                return { script, valid: true };
                            } catch (error) {
                                return { script, valid: false, error: error.message };
                            }
                        })
                        .catch(() => {
                            return { script, valid: false, error: '无法加载文件' };
                        });
                });
                
                Promise.all(loadChecks).then(results => {
                    const invalidScripts = results.filter(r => !r.valid);
                    
                    if (invalidScripts.length === 0) {
                        resultElement.className = 'test-result pass';
                        resultElement.innerHTML = '✓ 所有JavaScript文件语法有效';
                        testResults.syntax = true;
                    } else {
                        resultElement.className = 'test-result fail';
                        const errorList = invalidScripts.map(s => 
                            `${s.script}: ${s.error || '语法错误'}`
                        ).join('<br>');
                        resultElement.innerHTML = `✗ 语法错误:<br>${errorList}`;
                        testResults.syntax = false;
                    }
                    updateSummary();
                });
                
            } catch (error) {
                resultElement.className = 'test-result fail';
                resultElement.innerHTML = `✗ 测试执行错误: ${error.message}`;
                testResults.syntax = false;
                updateSummary();
            }
        }
        
        // 3. 迷宫生成测试
        function testMazeGeneration() {
            const resultElement = document.getElementById('maze-test-result');
            resultElement.className = 'test-result running';
            resultElement.innerHTML = '测试中...';
            
            // 动态加载maze.js
            const script = document.createElement('script');
            script.src = 'maze.js';
            script.onload = function() {
                try {
                    // 测试Maze类
                    if (typeof Maze !== 'undefined') {
                        // 创建迷宫实例
                        const maze = new Maze(10, 10);
                        
                        // 生成迷宫
                        maze.generate();
                        
                        // 检查基本属性
                        const size = maze.getSize();
                        const start = maze.getStart();
                        const end = maze.getEnd();
                        const path = maze.getPath();
                        
                        // 验证结果
                        const tests = [
                            { name: '迷宫宽度', condition: size.width === 10 },
                            { name: '迷宫高度', condition: size.height === 10 },
                            { name: '起点坐标', condition: start.x >= 0 && start.x < 10 && start.y >= 0 && start.y < 10 },
                            { name: '终点坐标', condition: end.x >= 0 && end.x < 10 && end.y >= 0 && end.y < 10 },
                            { name: '起点终点不同', condition: !(start.x === end.x && start.y === end.y) },
                            { name: '路径存在', condition: path.length > 0 }
                        ];
                        
                        const failedTests = tests.filter(test => !test.condition);
                        
                        if (failedTests.length === 0) {
                            resultElement.className = 'test-result pass';
                            resultElement.innerHTML = `
                                ✓ 迷宫生成测试通过<br>
                                - 大小: ${size.width}×${size.height}<br>
                                - 起点: (${start.x}, ${start.y})<br>
                                - 终点: (${end.x}, ${end.y})<br>
                                - 路径长度: ${path.length}步
                            `;
                            testResults.maze = true;
                        } else {
                            resultElement.className = 'test-result fail';
                            const failedNames = failedTests.map(t => t.name).join(', ');
                            resultElement.innerHTML = `✗ 迷宫生成测试失败: ${failedNames}`;
                            testResults.maze = false;
                        }
                    } else {
                        resultElement.className = 'test-result fail';
                        resultElement.innerHTML = '✗ Maze类未定义';
                        testResults.maze = false;
                    }
                } catch (error) {
                    resultElement.className = 'test-result fail';
                    resultElement.innerHTML = `✗ 迷宫生成错误: ${error.message}`;
                    testResults.maze = false;
                }
                updateSummary();
            };
            
            script.onerror = function() {
                resultElement.className = 'test-result fail';
                resultElement.innerHTML = '✗ 无法加载maze.js';
                testResults.maze = false;
                updateSummary();
            };
            
            document.head.appendChild(script);
        }
        
        // 4. 游戏逻辑测试
        function testGameLogic() {
            const resultElement = document.getElementById('game-test-result');
            resultElement.className = 'test-result running';
            resultElement.innerHTML = '测试中...';
            
            // 动态加载game.js和maze.js
            const mazeScript = document.createElement('script');
            mazeScript.src = 'maze.js';
            
            mazeScript.onload = function() {
                const gameScript = document.createElement('script');
                gameScript.src = 'game.js';
                
                gameScript.onload = function() {
                    try {
                        if (typeof Game !== 'undefined') {
                            // 创建游戏实例
                            const game = new Game({ mazeSize: 5, viewMode: 'permanent' });
                            
                            // 测试游戏状态
                            const initialState = game.getGameState();
                            
                            // 开始游戏
                            game.start();
                            const startedState = game.getGameState();
                            
                            // 测试移动
                            const moveResult1 = game.movePlayer(1, 0); // 尝试向右移动
                            const moveResult2 = game.movePlayer(0, 1); // 尝试向下移动
                            
                            // 获取移动后的状态
                            const afterMoveState = game.getGameState();
                            
                            // 验证结果
                            const tests = [
                                { name: '游戏实例创建', condition: game !== null },
                                { name: '初始状态非运行', condition: !initialState.isRunning },
                                { name: '开始后状态运行', condition: startedState.isRunning },
                                { name: '游戏统计存在', condition: game.getStats() !== null }
                            ];
                            
                            const failedTests = tests.filter(test => !test.condition);
                            
                            if (failedTests.length === 0) {
                                resultElement.className = 'test-result pass';
                                resultElement.innerHTML = `
                                    ✓ 游戏逻辑测试通过<br>
                                    - 游戏实例创建成功<br>
                                    - 初始状态: ${initialState.isRunning ? '运行中' : '未运行'}<br>
                                    - 开始后状态: ${startedState.isRunning ? '运行中' : '未运行'}<br>
                                    - 移动测试: ${moveResult1 ? '成功' : '失败'} (右), ${moveResult2 ? '成功' : '失败'} (下)<br>
                                    - 当前步数: ${afterMoveState.moves}
                                `;
                                testResults.game = true;
                            } else {
                                resultElement.className = 'test-result fail';
                                const failedNames = failedTests.map(t => t.name).join(', ');
                                resultElement.innerHTML = `✗ 游戏逻辑测试失败: ${failedNames}`;
                                testResults.game = false;
                            }
                        } else {
                            resultElement.className = 'test-result fail';
                            resultElement.innerHTML = '✗ Game类未定义';
                            testResults.game = false;
                        }
                    } catch (error) {
                        resultElement.className = 'test-result fail';
                        resultElement.innerHTML = `✗ 游戏逻辑错误: ${error.message}`;
                        testResults.game = false;
                    }
                    updateSummary();
                };
                
                gameScript.onerror = function() {
                    resultElement.className = 'test-result fail';
                    resultElement.innerHTML = '✗ 无法加载game.js';
                    testResults.game = false;
                    updateSummary();
                };
                
                document.head.appendChild(gameScript);
            };
            
            mazeScript.onerror = function() {
                resultElement.className = 'test-result fail';
                resultElement.innerHTML = '✗ 无法加载maze.js';
                testResults.game = false;
                updateSummary();
            };
            
            document.head.appendChild(mazeScript);
        }
        
        // 更新测试结果汇总
        function updateSummary() {
            const resultElement = document.getElementById('summary-result');
            const passedTests = Object.values(testResults).filter(result => result).length;
            const totalTests = Object.keys(testResults).length;
            
            if (passedTests === totalTests) {
                resultElement.className = 'test-result pass';
                resultElement.innerHTML = `✓ 所有测试通过 (${passedTests}/${totalTests})`;
            } else if (passedTests === 0) {
                resultElement.className = 'test-result fail';
                resultElement.innerHTML = `✗ 所有测试失败 (0/${totalTests})`;
            } else {
                resultElement.className = 'test-result running';
                resultElement.innerHTML = `⚠ 部分测试通过 (${passedTests}/${totalTests})`;
                
                // 显示详细结果
                const details = Object.entries(testResults).map(([test, passed]) => {
                    return `${test}: ${passed ? '✓' : '✗'}`;
                }).join('<br>');
                
                resultElement.innerHTML += `<br><small>${details}</small>`;
            }
        }
        
        // 页面加载时运行自动测试
        window.addEventListener('DOMContentLoaded', function() {
            testFileIntegrity();
            testJavaScriptSyntax();
        });
    </script>
</body>
</html>